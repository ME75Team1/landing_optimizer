# landing_optimizer

## Getting Started
### Prerequisites
- Ubuntu 20.04
- [Stereolabs zed-ros-wrapper](https://github.com/stereolabs/zed-ros-wrapper)
- [motor_controller](https://github.com/ME75Team1/motor_controller)
- [ROS Noetic](http://wiki.ros.org/noetic/Installation/Ubuntu)

### Build the Repository
The `landing_optimizer` is a catkin package. It depends on the following ROS packages:
- `roscpp`
- `rospy`
- `std_msgs`
- `ros_numpy`
- `cv_bridge`
- `rospy_message_converter`
- `message_generation`

Open a terminal, clone the respository, update the dependencies and build the packages:
```
cd ~/catkin_ws/src
git clone https://github.com/ME75Team1/landing_optimizer.git
cd ../
rosdep install --from-paths src --ignore-src -r -y
catkin_make
source ./devel/setup.bash
```

### Update the local repository
To update the repository to the latest release you must use the following command to retrieve the latest commits of `landing_optimizer`.

```
git checkout main # if you are not on the main branch
git pull
```
Remember to always clean the cache of your catkin workspace before compiling with the catkin_make command to be sure that everything will work as expected:
```
roscd
cd ..
rm -rf build devel
catkin_make
```

## Run the landing_optimizer
Launch the ZED node from the [zed-ros-wrapper](https://github.com/stereolabs/zed-ros-wrapper)

Choose to run one or both of the below nodes:

### Leg Height Calculator
- This node can be launched by `roslaunch landing_optimizer legsOnly.launch`.
  - `legsOnly.launch` loads params from [motor_controller](https://github.com/ME75Team1/motor_controller) so [motor_controller](https://github.com/ME75Team1/motor_controller) should be installed or `legsOnly.launch` should be modified.
- It reads the `/zed2/zed_node/depth/depth_registered` point clouds from the ZED node (see [here](https://www.stereolabs.com/docs/ros/zed-node) for documentation about the `depth/depth_registered` topic).
- By interpolating the point cloud, the node determines the vertical distance from each of the drone's legs to the ground.
  - These distances are published on `/leg_heights`.
  - Note that this interpolation requires the '/leg_positions/' parameters from [motor_controller](https://github.com/ME75Team1/motor_controller).
- The code for this node is in `scripts/LegMessage.py`

### Digital Elevation Model and Optimal Landing Location Calculator
- This node can be launched by `roslaunch landing_optimizer localMapping.launch`.
- It reads the `/zed2/zed_node/mapping/fused_cloud` point cloud generated by the ZED node if spatial mapping is on (see [here](https://www.stereolabs.com/docs/ros/zed-node) for more information.
- It converts the point cloud to a digital elevation model by interpolating the z values of the point cloud onto a grid in the xy plane. This interpolation is done using inverse distance weighting over the k-nearest neightbors to each grid point.
  - The interpolation is based on https://github.com/paulbrodersen/inverse_distance_weighting. The license for this code is included in the Python class where it appears in `scripts/PythonLandingROS.py`
  - A contour plot of the digital elevation model is published on `/optimizer/digital_elevation_model`.
  - The grid resolution used for this interpolation is set in `/terrain_model_resolution` in `params/mapping_params.yaml`. 
- The digital elevation model is used to calculate the maximum difference between the heights of each leg as a function of the (x,y) coordinate where the drone lands.
  - A contour plot of this maximum difference versus x and y is published on `/optimizer/optimal_landing_locations`.
- The code for this node is in `scripts/PythonLandingROS.py`.
- This node uses a noticeable amount of memory so it could cause the ZED node to run out of memory. Launching this node on a remote computer avoids this problem.
  - This node can be launched on a remote computer (even if it doesn't have [motor_controller](https://github.com/ME75Team1/motor_controller) installed) using `roslaunch landing_optimizer remoteMapping.launch`.

### Launching Both Nodes
- Both of the above nodes can be launched simultaneously using `roslaunch landing_optimizer landing.launch`.

## ZED Node Parameters
- Some of the ZED node parameters should be adjusted to improve the results of the above two nodes:
  - `general/pub_frame_rate`: In our use case, we set this to 1.0 since our motors are so slow that the default frame rate of 15.0 isn't necessary.
  - `depth/depth_mode`: Setting this to `'ULTRA'` worked well.
  - `pos_tracking/pos_tracking_mode`: Although Stereolabs recommends `'QUALITY'` for this parameter when using `'ULTRA'` for `depth_mode`, `'STANDARD'` worked fine.
  - `pos_tracking/path_pub_rate`: We also set this frame rate to 1.0 since we didn't need the default of 2.0.
  - `mapping/mapping_enabled`: We set this to `true` to enable spatial mapping
  - `mapping/resolution`: We set this to `0.02` for improved resolution.
  - `mapping/max_mapping_range`: We set this to 4.0 to ignore points that are far away.
  - `mapping/fused_pointcloud_freq`: We set this to 0.5 since the digital elevation model node runs at about this frequency so a faster frequency was unnecessary.
- The `common.yaml` file that we use is available at https://github.com/ME75Team1/zed-ros-wrapper/blob/master/zed_wrapper/params/common.yaml.
